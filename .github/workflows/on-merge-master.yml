
name: Deploy Staging

env:
  REACT_APP_WEBAPI_URL: 'https://westdaat-staging.azurewebsites.net/api/'
  REACT_APP_AUTH_REDIRECT_URL: 'https://westdaatstaging.westernstateswater.org/authredirect.html' # the URL used by Azure B2C to redirect to your app after login
  REACT_APP_AUTH_CLIENT_ID: 'a4db62cd-d2ef-425e-8c69-37f4349f925e'
  REACT_APP_AUTH_AUTHORITY: 'https://westdaatstaging.b2clogin.com/westdaatstaging.onmicrosoft.com/b2c_1_signupsignin'
  REACT_APP_AUTH_KNOWN_AUTHORITY: 'https://westdaatstaging.b2clogin.com/westdaatstaging.onmicrosoft.com'
  REACT_APP_WATER_RIGHTS_VECTOR_TILE_URL: 'https://api.maptiler.com/tiles/441a16bb-0a9e-4e71-8c84-da267d516a09/tiles.json?key=IauIQDaqjd29nJc5kJse'
  REACT_APP_GA_ID: 'G-KFL0TGM4B8'             # set the Google Analytics measurement ID

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy-backend:
    uses: ./.github/workflows/deploy-backend.yml
    with:
      azure-resource-group: WestDAAT_Staging
      azure-functionapp-name: westdaat-staging
      azure-apim-name: westdaatstaging
      azure-api-name: westdaat-fn-api-staging
      azure-api-url: https://westdaatstaging.azure-api.net/api
    secrets:
      azure-cli-credentials: ${{ secrets.AZURE_AZ_CLI_CREDENTIALS_STAGING }}
      azure-function-publish-profile: ${{ secrets.AZURE_FUNCTION_PUBLISH_PROFILE_STAGING }}
  deploy-frontend:
    uses: ./.github/workflows/deploy-frontend.yml
    needs: deploy-backend
    with:
      azure-resource-group: WestDAAT_Staging
      azure-storage-account-name: westdaatstaging
      azure-cdn-endpoint-name: westdaatstaging
      azure-cdn-profile-name: westdaatstaging
    secrets:
      azure-cli-credentials: ${{ secrets.AZURE_AZ_CLI_CREDENTIALS_QA }}